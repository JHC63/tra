<!DOCTYPE html>
  <html lang="zh-Hant">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設置自由座車廂</title>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
      /* CSS 變數定義 */
      :root {
        --font-size-base: 22px; /* 基礎字體大小 */
        --font-size-large: 25px; /* 用於主要標題和部分重要文字 */
        --font-size-button: 26px; /* 按鈕文字大小 */
        --font-size-tab: 32px;   /* 分頁按鈕文字大小 */
        --seat-table-cell-height: 75px; /* 座位表格單元格高度 */
        --container-max-width: 900px;
      }

      body {
        background-color: #000;
        color: black;
        font-family: Arial, sans-serif;
        text-align: center;
        font-size: var(--font-size-base);
        margin: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .container {
        max-width: var(--container-max-width);
        margin: 20px auto;
        padding: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }

      /* Tab styles */
      .tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }
      .tab-button {
        padding: 10px 20px;
        font-size: var(--font-size-tab); /* 分頁按鈕文字放大 8px */
        cursor: pointer;
        border: 1px solid #ccc;
        background-color: #f0f0f0;
        border-radius: 5px 5px 0 0;
        margin: 0 2px;
        transition: background-color 0.3s, color 0.3s;
      }
      .tab-button.active {
        background-color: white;
        border-bottom: 1px solid white;
        color: black;
        font-weight: bold;
      }
      .tab-content {
        display: none;
        padding: 20px;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 8px 8px;
        background-color: white;
        flex-grow: 1;
        overflow-y: auto;
        max-height: calc(100vh - 150px);
      }
      .tab-content.active {
        display: block;
      }

      /* Input and button styles */
      .input-group {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center; /* Center the items horizontally */
        width: 100%;
      }
      label {
        width: 180px;
        text-align: right;
        margin-right: 10px;
        white-space: nowrap;
        font-size: var(--font-size-large); /* 設置自由座車廂數、開始車廂文字大小為 25px */
      }

      /* Styles for '自由座車廂數' and '自由座開始車廂' input fields */
      .tab-content#settings-tab > .input-group input[type="number"],
      .tab-content#settings-tab > .input-group input[type="text"] {
        width: 100px; /* Half of original 200px */
        max-width: 100px; /* Ensure it respects max-width */
        flex-grow: 0; /* Prevents input from growing */
        padding: 5px;
        font-size: var(--font-size-base);
      }

      /* Styles for '停靠站' input fields */
      .station-input {
        width: 250px; /* Adjust width for station fields */
        max-width: 300px; /* Max width for station fields */
        flex-grow: 1; /* Allow station inputs to grow within their group */
        padding: 5px;
        font-size: var(--font-size-base);
      }

      button {
        padding: 10px 20px;
        font-size: var(--font-size-button); /* 按鈕文字放大 4px */
        background-color: white;
        color: black;
        border: 1px solid #333;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        white-space: nowrap;
      }
      button:hover {
        background-color: #f0f0f0;
      }
      .button-container {
        margin: 20px auto;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        width: 100%;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 30px;
      }
      .car-chart-container {
          margin-bottom: 40px;
          padding-bottom: 20px;
          border-bottom: 1px dashed #ccc;
      }
      .car-chart-container:last-child {
          border-bottom: none;
          margin-bottom: 20px;
      }

      table {
        border-collapse: collapse;
        margin: 30px auto 10px auto;
        background-color: white;
      }
      th, td {
        border: 1px solid #333;
        height: var(--seat-table-cell-height);
        text-align: center;
        vertical-align: middle;
        background-color: white;
        color: black;
        font-size: var(--font-size-base); /* 數字表格內的數字文字大小 */
      }
      /* Specific widths for seat number and station select cells */
      td.seat-number-cell {
          width: 30px; /* Smaller width for seat number */
          padding: 0;
      }
      td.station-select-cell {
          width: 100px; /* Wider width to accommodate station name */
          min-width: 80px; /* Ensure minimum width */
          max-width: 150px; /* Optional: set a max-width if names are very long */
          padding: 0; /* Remove padding for flexbox centering */
          cursor: pointer;
          transition: background-color 0.2s;
          /* Use flexbox for perfect centering */
          display: flex;
          align-items: center;
          justify-content: center;
      }
      td.station-select-cell:hover {
        background-color: #f0f0f0;
      }
      .station-label {
        font-size: calc(var(--font-size-base) + 4px); /* Enlarge font */
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .header, .footer {
        font-weight: bold;
        font-size: var(--font-size-large); /* 車廂號碼文字大小為 25px */
      }
      .seat.selected {
        background-color: #00ff00;
      }
      .aisle {
        background-color: #ddd;
      }

      /* Message box for copy success */
      .message-box {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px 30px;
        border-radius: 8px;
        z-index: 2000; /* Ensure it's on top */
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        pointer-events: none;
      }
      .message-box.show {
        opacity: 1;
      }
      .undo-button {
        background: none;
        border: none;
        font-size: var(--font-size-button); /* 上一步按鈕文字放大 4px */
        cursor: pointer;
        margin-right: 10px;
        vertical-align: middle;
      }
      .undo-button:hover {
          color: #555;
      }

      /* Quick Import Area Styles */
      .quick-import-area {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        position: relative;
        background-color: #f9f9f9;
        padding-top: 30px;
      }
      .quick-import-area::before {
        content: "快速導入";
        position: absolute;
        top: -15px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #f9f9f9;
        padding: 0 10px;
        font-weight: bold;
        font-size: var(--font-size-large); /* 統一為 25px */
        color: #333;
      }
      /* New style for the station filter area header */
      .quick-import-area.station-filter-area::before {
          content: "停靠站"; /* Change content for this specific area */
      }

      .quick-import-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }
      .quick-import-buttons button {
        flex: 1 1 calc(25% - 7.5px);
        max-width: calc(25% - 7.5px);
        margin: 0;
        font-size: var(--font-size-button); /* 放大 4px */
      }
      h1 {
          font-size: var(--font-size-large); /* 統一「設置自由座車廂」和「自由座座位表」文字大小為 25px */
          margin-top: 10px;
          margin-bottom: 20px;
      }
      h2 {
          font-size: var(--font-size-large); /* 統一「手動輸入停靠站」文字大小為 25px */
      }

      /* Modal (Floating Window) Styles */
      .modal {
        display: none; 
        position: fixed; 
        z-index: 1001; 
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto; 
        background-color: rgba(0,0,0,0.4); 
      }
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto; 
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 8px;
        position: relative;
      }
      .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }
      .close-button:hover,
      .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
      #modal-station-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
      }
      #modal-station-buttons button {
        flex: 1 1 150px;
      }


      /* 手機響應式調整 */
      @media (max-width: 768px) {
          :root {
              --font-size-base: 14px;
              --font-size-large: 18px;
              --font-size-button: 16px;
              --font-size-tab: 24px;
              --seat-table-cell-width: 35px; /* 手機上座位表格單元格更小 */
              --seat-table-cell-height: 60px;
              --container-max-width: 95%; /* 容器佔據更多螢幕寬度 */
          }

          .container {
              margin: 10px auto;
              padding: 10px;
          }

          .tab-button {
              padding: 8px 15px;
          }

          label {
              width: auto; /* 手機上標籤寬度自動調整 */
              text-align: left;
              margin-right: 5px;
              font-size: var(--font-size-large);
          }

          /* Specific adjustments for '自由座車廂數' and '自由座開始車廂' on mobile */
          .tab-content#settings-tab > .input-group input[type="number"],
          .tab-content#settings-tab > .input-group input[type="text"] {
              width: 80px; /* Keep them small on mobile */
              max-width: 80px;
              padding: 8px;
          }

          /* Specific adjustments for '停靠站' on mobile */
          .station-input {
              width: 100%; /* Make them full width on mobile */
              max-width: none;
              padding: 8px;
          }

          button {
              padding: 8px 15px;
              font-size: var(--font-size-button);
              margin: 3px;
          }

          .quick-import-buttons button {
              flex: 1 1 calc(50% - 5px); /* 手機上每行最多 2 個按鈕 */
              max-width: calc(50% - 5px);
          }

          table {
              min-width: unset; /* 移除最小寬度限制 */
              width: 100%; /* 表格寬度填滿 */
              font-size: var(--font-size-base);
          }
          th, td {
              height: var(--seat-table-cell-height);
              font-size: var(--font-size-base);
          }
          td.seat-number-cell {
              width: 25px; /* Adjust for mobile */
          }
          td.station-select-cell {
              width: 80px; /* Adjust for mobile */
              min-width: 60px;
              max-width: 100px;
          }
          .station-label {
              font-size: calc(var(--font-size-base) + 2px); /* Adjust font size for mobile */
          }
          .header, .footer {
              font-size: var(--font-size-large);
          }
          h1, h2 {
              font-size: var(--font-size-large);
          }
          .modal-content {
              width: 90%;
              margin: 25% auto;
          }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="tabs">
        <button class="tab-button active" onclick="openTab(event, 'settings-tab')">設定</button>
        <button class="tab-button" onclick="openTab(event, 'charts-tab')">座位表</button>
      </div>

      <div id="settings-tab" class="tab-content active">
        <div class="quick-import-area">
          <div class="quick-import-buttons">
            <button onclick="importQuickData('110次')">110次</button>
            <button onclick="importQuickData('111次')">111次</button>
            <button onclick="importQuickData('116次')">116次</button>
            <button onclick="importQuickData('131次')">131次</button>
            <button onclick="importQuickData('132次')">132次</button>
            <button onclick="importQuickData('143次')">143次</button>
            <button onclick="importQuickData('154次')">154次</button>
          </div>
        </div>
        <h1>設置自由座車廂</h1>
        <div class="input-group">
          <label for="num-cars">自由座車廂數：</label>
          <input type="number" id="num-cars" value="1" min="1">
        </div>
        <div class="input-group">
          <label for="start-car">自由座開始車廂：</label>
          <input type="number" id="start-car" value="9" min="1">
        </div>
        <h2>手動輸入停靠站(可以空白）</h2>
        <div id="stations-container"></div>
        <button onclick="addStationField()">新增停靠站欄位</button>
        <div>
          <button onclick="confirmSettings()">確定</button>
          <button onclick="resetSettingsToDefault()">清空</button>
        </div>
      </div>

      <div id="charts-tab" class="tab-content">
        <h1>自由座座位表</h1>
        <div style="margin-bottom: 20px;">
            <button class="undo-button" onclick="undoLastAction()" title="上一步">&#x21BA;</button>
            <button onclick="exportSeatingCharts()">匯出座位表</button>
            <button onclick="showHandoverQRCode()">交班Qrcode</button>
<p style="color: red; margin-top: 10px;">Qrcode只有1節自由座車廂可以使用（網址較短），3節自由座請使用匯出座位表按鈕分享網址。</p>
        </div>
        <div class="quick-import-area station-filter-area" style="margin-bottom: 20px;">
            <div class="quick-import-buttons" id="global-station-buttons"></div>
        </div>

        <div id="seating-charts">
          </div>
      </div>
    </div>

    <div id="message-box" class="message-box"></div>

    <div id="station-modal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeStationModal()">&times;</span>
        <h2>選擇下車站</h2>
        <div id="modal-station-buttons"></div>
      </div>
    </div>
    
    <div id="qrcode-modal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeQRCodeModal()">&times;</span>
        <h2>交班 QR Code</h2>
        <div id="qrcode-display" style="display: flex; justify-content: center; padding: 20px;"></div>
        <p style="text-align: center;">請使用另一裝置掃描此 QR Code 以載入目前的座位表狀態。</p>
      </div>
    </div>

    <script>
      // Define the seat layout for a single row.
      const seatLayout = [
        [1, 3, 4, 2], [5, 7, 8, 6], [9, 11, 12, 10], [13, 15, 16, 14],
        [17, 19, 20, 18], [21, 23, 24, 22], [25, 27, 28, 26], [29, 31, 32, 30],
        [33, 35, 36, 34], [37, 39, 40, 38], [41, 43, 44, 42], [45, 47, 48, 46],
        [49, 51, 52, 50]
      ];

      // Store the state for each car's perspective
      const carPerspectiveState = {};
      let currentStations = []; // To store stations for consistent use across functions
      let lastActiveStationFilter = null; // Stores the last clicked station for filtering

      // Default values for settings
      const defaultNumCars = 1;
      const defaultStartCar = 9;
      const defaultStationFields = 15; // Number of empty station input fields to show by default

      // History for undo functionality
      let history = [];
      let historyPointer = -1;

      /**
       * Predefined train data for quick import.
       */
      const trainDataPresets = {
          '110次': {
              numCars: 1,
              startCar: 9,
              stations: ["屏東", "高雄", "臺南", "嘉義", "彰化", "台中", "豐原", "板橋","臺北", "松山", "南港", "七堵"]
          },
          '111次': {
              numCars: 1,
              startCar: 9,
              stations: ["南港", "松山", "臺北", "板橋", "桃園", "台中", "嘉義", "臺南", "高雄", "屏東", "潮州", "枋寮"]
          },
          '116次': {
              numCars: 3,
              startCar: 9,
              stations: ["屏東", "九曲堂", "鳳山", "高雄", "新左營", "臺南", "新營", "嘉義", "斗南", "斗六", "員林", "彰化", "台中", "豐原", "苗栗", "竹南", "新竹", "中壢", "桃園", "板橋", "臺北", "松山", "汐止", "七堵"]
          },
          '131次': {
              numCars: 1,
              startCar: 9,
              stations: ["嘉義", "臺南", "高雄", "屏東", "潮州"]
          },
          '132次': {
              numCars: 1,
              startCar: 9,
              stations: ["潮州", "屏東", "高雄", "臺南", "嘉義", "彰化", "台中", "新竹", "板橋","臺北", "松山", "南港", "七堵"]
          },
          '143次': {
              numCars: 1,
              startCar: 9,
              stations: ["臺南", "高雄", "鳳山", "屏東", "潮州"]
          },
          '154次': {
              numCars: 1,
              startCar: 9,
              stations: ["屏東", "高雄", "臺南", "嘉義", "台中", "桃園", "板橋", "臺北", "松山", "南港"]
          }
      };

      /**
       * Saves the current state of the seating chart and settings to the history array.
       */
      function saveState() {
          const numCars = document.getElementById('num-cars').value;
          const startCar = document.getElementById('start-car').value;
          const stations = Array.from(document.querySelectorAll('.station-input')).map(input => input.value.trim());

          // Get current seat selections from the station-label spans
          const seatSelections = {};
          document.querySelectorAll('.station-label').forEach(label => {
              if (label.textContent) {
                  // The ID is "label-carNumber-seatNumber", so we substring(6) to get the base ID
                  seatSelections[label.id.substring(6)] = label.textContent;
              }
          });

          const state = {
              numCars: numCars,
              startCar: startCar,
              stations: stations,
              seatSelections: seatSelections,
              carPerspectives: { ...carPerspectiveState },
              lastFilter: lastActiveStationFilter
          };

          if (historyPointer < history.length - 1) {
              history = history.slice(0, historyPointer + 1);
          }
          history.push(state);
          historyPointer = history.length - 1;
      }

      /**
       * Loads a specific state from the history array and applies it to the UI.
       */
      function loadState(state) {
          if (!state) return;

          document.getElementById('num-cars').value = state.numCars || defaultNumCars;
          document.getElementById('start-car').value = state.startCar || defaultStartCar;

          const stationsContainer = document.getElementById('stations-container');
          stationsContainer.innerHTML = '';
          state.stations.forEach(station => {
              addStationField();
              stationsContainer.lastElementChild.querySelector('.station-input').value = station;
          });
          while (stationsContainer.children.length < defaultStationFields) {
              addStationField();
          }

          for (const carNum in carPerspectiveState) { delete carPerspectiveState[carNum]; }
          if (state.carPerspectives) {
              Object.assign(carPerspectiveState, state.carPerspectives);
          }

          confirmSettings(false);

          setTimeout(() => {
              // Apply seat selections to the labels
              if (state.seatSelections) {
                  document.querySelectorAll('.station-label').forEach(label => {
                      const seatIdBase = label.id.substring(6);
                      const seatNumId = `seat-${seatIdBase}`;
                      const selectedStation = state.seatSelections[seatIdBase] || '';
                      
                      label.textContent = selectedStation;
                      toggleSeatColor(seatNumId, selectedStation);
                  });
              }

              if (state.lastFilter && currentStations.includes(state.lastFilter)) {
                  updateStations(state.lastFilter, currentStations);
              } else {
                  const buttons = document.querySelectorAll('#global-station-buttons button');
                  buttons.forEach(button => {
                      button.style.display = 'inline-block';
                      button.classList.remove('active-filter');
                  });
              }
          }, 50);
      }
      
      /**
       * Reverts the seating chart state to the previous step in history.
       */
      function undoLastAction() {
          if (historyPointer > 0) {
              historyPointer--;
              loadState(history[historyPointer]);
          } else {
              showMessage('沒有上一步的動作了');
          }
      }

      // --- Tab Switching Logic ---
      function openTab(evt, tabId) {
        const tabContents = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabContents.length; i++) {
          tabContents[i].style.display = "none";
        }
        const tabButtons = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tabButtons.length; i++) {
          tabButtons[i].className = tabButtons[i].className.replace(" active", "");
        }
        document.getElementById(tabId).style.display = "block";
        if (evt) {
          evt.currentTarget.className += " active";
        } else {
            const targetButton = document.querySelector(`.tab-button[onclick*="'${tabId}'"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
        }
      }

      // --- Station Field Management ---
      function addStationField() {
        const container = document.getElementById('stations-container');
        const index = container.children.length + 1;
        const newField = document.createElement('div');
        newField.className = 'input-group';
        newField.innerHTML = `<input type="text" class="station-input" placeholder="停靠站${index}">`;
        container.appendChild(newField);
      }

      /**
       * Resets all input fields in the settings tab to their default values.
       */
      function resetSettingsToDefault() {
        document.getElementById('num-cars').value = defaultNumCars;
        document.getElementById('start-car').value = defaultStartCar;
        const container = document.getElementById('stations-container');
        container.innerHTML = '';
        for (let i = 0; i < defaultStationFields; i++) {
          addStationField();
        }
        document.getElementById('seating-charts').innerHTML = '';
        document.getElementById('global-station-buttons').innerHTML = '';
        lastActiveStationFilter = null;
        for (const carNum in carPerspectiveState) {
            delete carPerspectiveState[carNum];
        }
        history = [];
        historyPointer = -1;
      }

      /**
       * Confirms settings, generates seating charts, and optionally saves the state.
       */
      function confirmSettings(saveToHistory = true) {
        const numCars = parseInt(document.getElementById('num-cars').value) || defaultNumCars;
        const startCar = parseInt(document.getElementById('start-car').value) || defaultStartCar;
        currentStations = Array.from(document.querySelectorAll('.station-input'))
          .map(input => input.value.trim())
          .filter(val => val !== '');

        if (currentStations.length === 0) {
          alert('請至少輸入一個停靠站！');
          return;
        }

        const output = document.getElementById('seating-charts');
        output.innerHTML = '';

        const globalStationButtonsContainer = document.getElementById('global-station-buttons');
        globalStationButtonsContainer.innerHTML = '';
        currentStations.forEach(station => {
          const button = document.createElement('button');
          button.textContent = station;
          button.onclick = () => {
              updateStations(station, currentStations);
              saveState();
          };
          globalStationButtonsContainer.appendChild(button);
        });
        lastActiveStationFilter = null;

        for (let car = startCar; car < startCar + numCars; car++) {
          if (carPerspectiveState[car] === undefined) {
              carPerspectiveState[car] = false;
          }
          output.appendChild(generateSeatingChart(car, currentStations, carPerspectiveState[car]));
        }

        if (saveToHistory) {
            saveState();
        }
        openTab(null, 'charts-tab');
      }

      /**
       * Generates the HTML structure for a single car's seating chart.
       */
      function generateSeatingChart(carNumber, stations, isFlipped) {
        const carContainer = document.createElement('div');
        carContainer.className = 'car-chart-container';
        carContainer.id = `car-chart-${carNumber}`;

        const table = document.createElement('table');
        let displaySeatLayout = JSON.parse(JSON.stringify(seatLayout));

        if (isFlipped) {
            displaySeatLayout.forEach(row => row.reverse());
            displaySeatLayout.reverse();
        }

        const headerText = `第${carNumber}車`;
        const footerText = `第${carNumber}車`;

        let html = `<tr><th colspan="9" class="header">${headerText}</th></tr>`;
        html += `
          <tr>
            <th colspan="2" class="label">窗戶</th>
            <th colspan="2" class="label">走道</th>
            <th class="empty"></th>
            <th colspan="2" class="label">走道</th>
            <th colspan="2" class="label">窗戶</th>
          </tr>
        `;

        displaySeatLayout.forEach(row => {
          html += '<tr>';
          row.forEach((seatNum, index) => {
            const seatIdBase = `${carNumber}-${seatNum}`;
            html += `<td class="seat seat-number-cell" id="seat-${seatIdBase}">${seatNum}</td>`;
            // This cell is now a clickable button that opens the modal
            html += `<td class="station-select-cell" onclick="openStationModal('${seatIdBase}')">
                       <span class="station-label" id="label-${seatIdBase}"></span>
                     </td>`;

            if (index === 1) {
              html += '<td class="aisle"></td>';
            }
          });
          html += '</tr>';
        });

        html += `
          <tr>
            <th colspan="2" class="label">窗戶</th>
            <th colspan="2" class="label">走道</th>
            <th class="empty"></th>
            <th colspan="2" class="label">走道</th>
            <th colspan="2" class="label">窗戶</th>
          </tr>
          <tr><th colspan="9" class="footer">${footerText}</th></tr>
        `;

        table.innerHTML = html;
        carContainer.appendChild(table);

        const toggleButton = document.createElement('button');
        toggleButton.id = `toggle-perspective-${carNumber}`;
        toggleButton.textContent = '視角切換';
        toggleButton.onclick = () => {
            toggleIndividualPerspective(carNumber, stations);
            saveState();
        };
        carContainer.appendChild(toggleButton);

        return carContainer;
      }

      /**
       * Toggles the background color of a seat based on whether a station is selected.
       */
      function toggleSeatColor(seatId, value) {
        const seat = document.getElementById(seatId);
        if (seat) {
          if (value) {
            seat.classList.add('selected');
          } else {
            seat.classList.remove('selected');
          }
        }
      }

      /**
       * Updates the global station filter. This function now also clears selections
       * for stations that are being filtered out.
       */
      function updateStations(selectedStation, stations) {
        lastActiveStationFilter = selectedStation;
        const selectedIndex = stations.indexOf(selectedStation);

        const buttons = document.querySelectorAll('#global-station-buttons button');
        buttons.forEach(button => {
            button.classList.remove('active-filter');
            if (button.textContent === selectedStation) {
                button.classList.add('active-filter');
            }
            const buttonIndex = stations.indexOf(button.textContent);
            button.style.display = buttonIndex < selectedIndex ? 'none' : 'inline-block';
        });

        // Clear selections for stations that are no longer valid
        document.querySelectorAll('.station-label').forEach(label => {
            const currentSelection = label.textContent;
            if (currentSelection && stations.indexOf(currentSelection) <= selectedIndex) {
                const seatIdBase = label.id.substring(6);
                label.textContent = '';
                toggleSeatColor(`seat-${seatIdBase}`, '');
            }
        });
      }
      
      /**
       * Toggles the perspective for a specific car.
       */
      function toggleIndividualPerspective(carNumber, stations) {
          carPerspectiveState[carNumber] = !carPerspectiveState[carNumber];

          const oldCarChartContainer = document.getElementById(`car-chart-${carNumber}`);
          if (oldCarChartContainer) {
              const currentCarSelections = {};
              oldCarChartContainer.querySelectorAll('.station-label').forEach(label => {
                  currentCarSelections[label.id.substring(6)] = label.textContent;
              });

              const newCarChartContainer = generateSeatingChart(carNumber, stations, carPerspectiveState[carNumber]);
              oldCarChartContainer.parentNode.replaceChild(newCarChartContainer, oldCarChartContainer);

              for (const seatIdBase in currentCarSelections) {
                  const labelElement = document.getElementById(`label-${seatIdBase}`);
                  if (labelElement) {
                      const station = currentCarSelections[seatIdBase];
                      labelElement.textContent = station;
                      toggleSeatColor(`seat-${seatIdBase}`, station);
                  }
              }
          }
      }

      /**
       * Generates the export URL with the current state.
       * @returns {string} The generated URL.
       */
      function generateExportUrl() {
        const numCars = document.getElementById('num-cars').value;
        const startCar = document.getElementById('start-car').value;
        const stations = Array.from(document.querySelectorAll('.station-input')).map(input => input.value.trim());

        const seatSelections = {};
        document.querySelectorAll('.station-label').forEach(label => {
          if (label.textContent) {
            seatSelections[label.id.substring(6)] = label.textContent;
          }
        });

        const exportData = {
          numCars: numCars,
          startCar: startCar,
          stations: stations,
          seatSelections: seatSelections,
          carPerspectives: carPerspectiveState,
          lastFilter: lastActiveStationFilter
        };
        
        const hash = LZString.compressToEncodedURIComponent(JSON.stringify(exportData));
        const currentUrl = window.location.href.split('#')[0];
        return `${currentUrl}#${hash}`;
      }

      /**
       * Copies the export URL to the clipboard.
       */
      function exportSeatingCharts() {
        const newUrl = generateExportUrl();
        window.history.replaceState(null, '', newUrl);

        navigator.clipboard.writeText(newUrl).then(() => {
          showMessage('已複製連結');
        }).catch(err => {
          console.error('複製失敗:', err);
          showMessage('複製失敗，請手動複製網址');
        });
      }

      /**
       * Displays a temporary message box.
       */
      function showMessage(message) {
        const messageBox = document.getElementById('message-box');
        messageBox.textContent = message;
        messageBox.classList.add('show');
        setTimeout(() => {
          messageBox.classList.remove('show');
        }, 2000);
      }

      /**
       * Loads settings and seating chart data from the URL hash.
       */
      function loadSettingsFromHash() {
        if (location.hash && location.hash.length > 1) {
          try {
            const decompressedString = LZString.decompressFromEncodedURIComponent(location.hash.substring(1));
            if (!decompressedString) {
                throw new Error("Decompression failed, hash is invalid or empty.");
            }
            const hashData = JSON.parse(decompressedString);
            
            document.getElementById('num-cars').value = hashData.numCars || defaultNumCars;
            document.getElementById('start-car').value = hashData.startCar || defaultStartCar;

            const stationsContainer = document.getElementById('stations-container');
            stationsContainer.innerHTML = '';
            hashData.stations.forEach(station => {
              addStationField();
              stationsContainer.lastElementChild.querySelector('.station-input').value = station;
            });
            while (stationsContainer.children.length < defaultStationFields) {
                addStationField();
            }

            for (const carNum in carPerspectiveState) { delete carPerspectiveState[carNum]; }
            if (hashData.carPerspectives) {
                Object.assign(carPerspectiveState, hashData.carPerspectives);
            }

            confirmSettings(false);

            setTimeout(() => {
                if (hashData.seatSelections) {
                    for (const seatIdBase in hashData.seatSelections) {
                        const labelId = `label-${seatIdBase}`;
                        const seatNumId = `seat-${seatIdBase}`;
                        const labelElement = document.getElementById(labelId);
                        if (labelElement) {
                            const station = hashData.seatSelections[seatIdBase];
                            labelElement.textContent = station;
                            toggleSeatColor(seatNumId, station);
                        }
                    }
                }

                if (hashData.lastFilter && currentStations.includes(hashData.lastFilter)) {
                    updateStations(hashData.lastFilter, currentStations);
                } else {
                    const buttons = document.querySelectorAll('#global-station-buttons button');
                    buttons.forEach(button => {
                        button.style.display = 'inline-block';
                        button.classList.remove('active-filter');
                    });
                }
            }, 100);

            openTab(null, 'charts-tab');
            saveState();

          } catch (e) {
            console.error("Failed to parse hash:", e);
            alert("無法解析網址中的座位表資料，請檢查連結是否正確。將恢復預設設定。");
            resetSettingsToDefault();
            openTab(null, 'settings-tab');
          }
        } else {
          resetSettingsToDefault();
          openTab(null, 'settings-tab');
        }
      }

      /**
       * Imports predefined train data into the settings fields.
       */
      function importQuickData(trainName) {
          const preset = trainDataPresets[trainName];
          if (preset) {
              document.getElementById('num-cars').value = preset.numCars;
              document.getElementById('start-car').value = preset.startCar;
              const stationsContainer = document.getElementById('stations-container');
              stationsContainer.innerHTML = '';
              preset.stations.forEach(station => {
                  addStationField();
                  stationsContainer.lastElementChild.querySelector('.station-input').value = station;
              });
              while (stationsContainer.children.length < defaultStationFields) {
                  addStationField();
              }
              document.querySelectorAll('.station-label').forEach(label => {
                  label.textContent = '';
                  toggleSeatColor(`seat-${label.id.substring(6)}`, '');
              });
              for (const carNum in carPerspectiveState) { delete carPerspectiveState[carNum]; }
              confirmSettings();
          } else {
              console.error('Unknown train preset:', trainName);
          }
      }

      // --- Modal Functions ---
      const stationModal = document.getElementById('station-modal');
      const qrCodeModal = document.getElementById('qrcode-modal');
      const qrCodeDisplay = document.getElementById('qrcode-display');
      let qrCodeInstance = null;

      function openStationModal(seatIdBase) {
        stationModal.dataset.seatId = seatIdBase; // Store which seat is being edited
        const buttonContainer = document.getElementById('modal-station-buttons');
        buttonContainer.innerHTML = ''; // Clear old buttons

        const filterIndex = lastActiveStationFilter ? currentStations.indexOf(lastActiveStationFilter) : -1;
        const availableStations = currentStations.filter((_, index) => index > filterIndex);

        const clearButton = document.createElement('button');
        clearButton.textContent = '清除';
        clearButton.style.backgroundColor = '#ffdddd';
        clearButton.onclick = () => setStationForSeat('', seatIdBase);
        buttonContainer.appendChild(clearButton);

        availableStations.forEach(station => {
          const button = document.createElement('button');
          button.textContent = station;
          button.onclick = () => setStationForSeat(station, seatIdBase);
          buttonContainer.appendChild(button);
        });
        
        stationModal.style.display = 'block';
      }

      function closeStationModal() {
        stationModal.style.display = 'none';
      }

      function setStationForSeat(stationName, seatIdBase) {
        const label = document.getElementById(`label-${seatIdBase}`);
        if (label) {
          label.textContent = stationName;
        }
        toggleSeatColor(`seat-${seatIdBase}`, stationName);
        closeStationModal();
        saveState();
      }

      function showHandoverQRCode() {
        const url = generateExportUrl();
        
        qrCodeDisplay.innerHTML = ''; // Clear previous QR code if any
        
        new QRCode(qrCodeDisplay, {
            text: url,
            width: 256,
            height: 256,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });

        qrCodeModal.style.display = 'block';
      }

      function closeQRCodeModal() {
          qrCodeModal.style.display = 'none';
          qrCodeDisplay.innerHTML = ''; // Clean up the QR code to free memory
      }
      
      // Close modal if user clicks outside of the content area
      window.onclick = function(event) {
        if (event.target == stationModal) {
          closeStationModal();
        }
        if (event.target == qrCodeModal) {
          closeQRCodeModal();
        }
      }

      // Initialize on page load
      window.onload = function() {
        loadSettingsFromHash();
      };
    </script>
  </body>
  </html>
